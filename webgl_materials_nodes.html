<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Verge3D webgl - node material</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
      body {
        color: #fff;
        font-family:Monospace;
        font-size:13px;
        margin: 0px;
        text-align:center;
        overflow: hidden;
      }

      #info {
        color: #fff;
        position: absolute;
        top: 10px;
        width: 100%;
        text-align: center;
        display:block;
      }

      a { color: white }
    </style>
  </head>
  <body>

    <div id="container"></div>
    <div id="info">
      <a href="https://www.soft8soft.com/verge3d" target="_blank" rel="noopener">Verge3D</a> - Node-Based Material
    </div>

    <script src="../build/v3d.js"></script>

    <script src='js/geometries/TeapotBufferGeometry.js'></script>
    <script src="js/controls/OrbitControls.js"></script>
    <script src="js/libs/dat.gui.min.js"></script>

    <!-- NodeLibrary -->
    <script src="js/nodes/GLNode.js"></script>
    <script src="js/nodes/RawNode.js"></script>
    <script src="js/nodes/TempNode.js"></script>
    <script src="js/nodes/InputNode.js"></script>
    <script src="js/nodes/ConstNode.js"></script>
    <script src="js/nodes/VarNode.js"></script>
    <script src="js/nodes/FunctionNode.js"></script>
    <script src="js/nodes/FunctionCallNode.js"></script>
    <script src="js/nodes/AttributeNode.js"></script>
    <script src="js/nodes/NodeBuilder.js"></script>
    <script src="js/nodes/NodeLib.js"></script>
    <script src="js/nodes/NodeMaterial.js"></script>

    <!-- Accessors -->
    <script src="js/nodes/accessors/PositionNode.js"></script>
    <script src="js/nodes/accessors/NormalNode.js"></script>
    <script src="js/nodes/accessors/UVNode.js"></script>
    <script src="js/nodes/accessors/ScreenUVNode.js"></script>
    <script src="js/nodes/accessors/ColorsNode.js"></script>
    <script src="js/nodes/accessors/CameraNode.js"></script>
    <script src="js/nodes/accessors/ReflectNode.js"></script>
    <script src="js/nodes/accessors/LightNode.js"></script>

    <!-- Inputs -->
    <script src="js/nodes/inputs/IntNode.js"></script>
    <script src="js/nodes/inputs/FloatNode.js"></script>
    <script src="js/nodes/inputs/ColorNode.js"></script>
    <script src="js/nodes/inputs/Vector2Node.js"></script>
    <script src="js/nodes/inputs/Vector3Node.js"></script>
    <script src="js/nodes/inputs/Vector4Node.js"></script>
    <script src="js/nodes/inputs/TextureNode.js"></script>
    <script src="js/nodes/inputs/Matrix4Node.js"></script>
    <script src="js/nodes/inputs/CubeTextureNode.js"></script>

    <!-- Math -->
    <script src="js/nodes/math/Math1Node.js"></script>
    <script src="js/nodes/math/Math2Node.js"></script>
    <script src="js/nodes/math/Math3Node.js"></script>
    <script src="js/nodes/math/OperatorNode.js"></script>

    <!-- Utils -->
    <script src="js/nodes/utils/SwitchNode.js"></script>
    <script src="js/nodes/utils/JoinNode.js"></script>
    <script src="js/nodes/utils/TimerNode.js"></script>
    <script src="js/nodes/utils/RoughnessToBlinnExponentNode.js"></script>
    <script src="js/nodes/utils/VelocityNode.js"></script>
    <script src="js/nodes/utils/LuminanceNode.js"></script>
    <script src="js/nodes/utils/ColorAdjustmentNode.js"></script>
    <script src="js/nodes/utils/NoiseNode.js"></script>
    <script src="js/nodes/utils/ResolutionNode.js"></script>
    <script src="js/nodes/utils/BumpNode.js"></script>
    <script src="js/nodes/utils/BlurNode.js"></script>
    <script src="js/nodes/utils/UVTransformNode.js"></script>

    <!-- Phong Material -->
    <script src="js/nodes/materials/PhongNode.js"></script>
    <script src="js/nodes/materials/PhongNodeMaterial.js"></script>

    <!-- Standard Material -->
    <script src="js/nodes/materials/StandardNode.js"></script>
    <script src="js/nodes/materials/StandardNodeMaterial.js"></script>

    <script>

    var container = document.getElementById('container');

    var renderer, scene, camera, clock = new v3d.Clock(), fov = 50;
    var teapot, mesh;
    var controls;
    var move = false;
    var rtTexture, rtMaterial;
    var gui, guiElements = [];
    var textures = {
      brick: { url: 'textures/brick_diffuse.jpg' },
      grass: { url: 'textures/terrain/grasslight-big.jpg' },
      grassNormal: { url: 'textures/terrain/grasslight-big-nm.jpg' },
      decalDiffuse: { url: 'textures/decal/decal-diffuse.png' },
      cloud: { url: 'textures/lava/cloud.png' },
      spherical: { url: 'textures/envmap.png' }
    };

    var param = { example: 'standard' };

    function getTexture(name) {

      var texture = textures[name].texture;

      if (! texture) {

        texture = textures[name].texture = new v3d.TextureLoader().load(textures[name].url);
        texture.wrapS = texture.wrapT = v3d.RepeatWrapping;

      }

      return texture;

    }

    var cubemap = function() {

      var path = "textures/cube/Park2/";
      var format = '.jpg';
      var urls = [
        path + 'posx' + format, path + 'negx' + format,
        path + 'posy' + format, path + 'negy' + format,
        path + 'posz' + format, path + 'negz' + format
      ];

      var textureCube = new v3d.CubeTextureLoader().load(urls);
      textureCube.format = v3d.RGBFormat;

      return textureCube;

    }();

    window.addEventListener('load', init);

    function init() {

      renderer = new v3d.WebGLRenderer({ antialias: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      container.appendChild(renderer.domElement);

      scene = new v3d.Scene();

      camera = new v3d.PerspectiveCamera(fov, window.innerWidth / window.innerHeight, 1, 1000);
      camera.position.x = 50;
      camera.position.z = - 50;
      camera.position.y = 30;
      camera.target = new v3d.Vector3();

      controls = new v3d.OrbitControls(camera, renderer.domElement);
      controls.minDistance = 50;
      controls.maxDistance = 200;

      scene.add(new v3d.AmbientLight(0x464646));

      var light = new v3d.DirectionalLight(0xffddcc, 1);
      light.position.set(1, 0.75, 0.5);
      scene.add(light);

      var light = new v3d.DirectionalLight(0xccccff, 1);
      light.position.set(- 1, 0.75, - 0.5);
      scene.add(light);

      teapot = new v3d.TeapotBufferGeometry(15, 18);

      mesh = new v3d.Mesh(teapot);
      scene.add(mesh);

      window.addEventListener('resize', onWindowResize, false);

      updateMaterial();

      onWindowResize();
      animate();

    }

    function clearGui() {

      if (gui) gui.destroy();

      gui = new dat.GUI();

      var example = gui.add(param, 'example', {
        'basic / standard': 'standard',
        'basic / physical': 'physical',
        'basic / phong': 'phong',
        'basic / layers': 'layers',
        'basic / rim': 'rim',
        'basic / color-adjustment': 'color-adjustment',
        'basic / uv-transform': 'uv-transform',
        'basic / bump': 'bump',
        'basic / blur': 'blur',
        'basic / spherical-reflection': 'spherical-reflection',
        'adv / fresnel': 'fresnel',
        'adv / saturation': 'saturation',
        'adv / top-bottom': 'top-bottom',
        'adv / skin': 'skin',
        'adv / skin-phong': 'skin-phong',
        'adv / caustic': 'caustic',
        'adv / displace': 'displace',
        'adv / plush': 'plush',
        'adv / toon': 'toon',
        'adv / camera-depth': 'camera-depth',
        'adv / soft-body': 'soft-body',
        'adv / wave': 'wave',
        'adv / triangle-blur': 'triangle-blur',
        'adv / expression': 'expression',
        'adv / sss': 'sss',
        'adv / translucent': 'translucent',
        'misc / smoke': 'smoke',
        'misc / firefly': 'firefly',
        'misc / reserved-keywords': 'reserved-keywords',
        'misc / varying': 'varying',
        'misc / custom-attribute': 'custom-attribute'
      }).onFinishChange(function() {

        updateMaterial();

      });

      gui.open();

    }

    function addGui(name, value, callback, isColor, min, max) {

      var node;

      param[name] = value;

      if (isColor) {

        node = gui.addColor(param, name).onChange(function() {

          callback(param[name]);

        });

      } else if (typeof value == 'object') {

        node = gui.add(param, name, value).onChange(function() {

          callback(param[name]);

        });

      } else {

        node = gui.add(param, name, min, max).onChange(function() {

          callback(param[name]);

        });

      }

      return node;

    }

    function updateMaterial() {

      move = false;

      if (mesh.material) mesh.material.dispose();

      if (rtTexture) {

        rtTexture.dispose();
        rtTexture = null;

      }

      if (rtMaterial) {

        rtMaterial.dispose();
        rtMaterial = null;

      }

      var name = param.example;
      var mtl;

      clearGui();

      switch (name) {

        case 'phong':

          // MATERIAL

          mtl = new v3d.PhongNodeMaterial();

          //mtl.color = // albedo (vec3)
          //mtl.alpha = // opacity (float)
          //mtl.specular = // specular color (vec3)
          //mtl.shininess = // shininess (float)
          //mtl.normal = // normalmap (vec3)
          //mtl.normalScale = // normalmap scale (vec2)
          //mtl.emissive = // emissive color (vec3)
          //mtl.ambient = // ambient color (vec3)
          //mtl.shadow = // shadowmap (vec3)
          //mtl.light = // custom-light (vec3)
          //mtl.ao = // ambient occlusion (float)
          //mtl.light = // input/output light (vec3)
          //mtl.environment = // reflection/refraction (vec3)
          //mtl.environmentAlpha = // environment alpha (float)
          //mtl.transform = // vertex transformation (vec3)

          var mask = new v3d.SwitchNode(new v3d.TextureNode(getTexture("decalDiffuse")), 'w');

          mtl.color = new v3d.TextureNode(getTexture("grass"));
          mtl.specular = new v3d.FloatNode(.5);
          mtl.shininess = new v3d.FloatNode(15);
          mtl.environment = new v3d.CubeTextureNode(cubemap);
          mtl.environmentAlpha = mask;
          mtl.normal = new v3d.TextureNode(getTexture("grassNormal"));
          mtl.normalScale = new v3d.Math1Node(mask, v3d.Math1Node.INVERT);

          break;

        case 'standard':

          // MATERIAL

          mtl = new v3d.StandardNodeMaterial();

          //mtl.color = // albedo (vec3)
          //mtl.alpha = // opacity (float)
          //mtl.roughness = // roughness (float)
          //mtl.metalness = // metalness (float)
          //mtl.normal = // normalmap (vec3)
          //mtl.normalScale = // normalmap scale (vec2)
          //mtl.emissive = // emissive color (vec3)
          //mtl.ambient = // ambient color (vec3)
          //mtl.shadow = // shadowmap (vec3)
          //mtl.light = // custom-light (vec3)
          //mtl.ao = // ambient occlusion (float)
          //mtl.environment = // reflection/refraction (vec3)
          //mtl.transform = // vertex transformation (vec3)

          var mask = new v3d.SwitchNode(new v3d.TextureNode(getTexture("decalDiffuse")), 'w');

          var normalScale = new v3d.FloatNode(.3);

          var roughnessA = new v3d.FloatNode(.5);
          var metalnessA = new v3d.FloatNode(.5);

          var roughnessB = new v3d.FloatNode(0);
          var metalnessB = new v3d.FloatNode(1);

          var roughness = new v3d.Math3Node(
            roughnessA,
            roughnessB,
            mask,
            v3d.Math3Node.MIX
          );

          var metalness = new v3d.Math3Node(
            metalnessA,
            metalnessB,
            mask,
            v3d.Math3Node.MIX
          );

          var normalMask = new v3d.OperatorNode(
            new v3d.Math1Node(mask, v3d.Math1Node.INVERT),
            normalScale,
            v3d.OperatorNode.MUL
          );

          mtl.color = new v3d.ColorNode(0xEEEEEE);
          mtl.roughness = roughness;
          mtl.metalness = metalness;
          mtl.environment = new v3d.CubeTextureNode(cubemap);
          mtl.normal = new v3d.TextureNode(getTexture("grassNormal"));
          mtl.normalScale = normalMask;

          // GUI

          addGui('color', mtl.color.value.getHex(), function(val) {

            mtl.color.value.setHex(val);

          }, true);

          addGui('roughnessA', roughnessA.number, function(val) {

             roughnessA.number = val;

          }, false, 0, 1);

          addGui('metalnessA', metalnessA.number, function(val) {

            metalnessA.number = val;

          }, false, 0, 1);

          addGui('roughnessB', roughnessB.number, function(val) {

             roughnessB.number = val;

          }, false, 0, 1);

          addGui('metalnessB', metalnessB.number, function(val) {

            metalnessB.number = val;

          }, false, 0, 1);

          addGui('normalScale', normalScale.number, function(val) {

            normalScale.number = val;

          }, false, 0, 1);

          break;

        case 'physical':

            // MATERIAL

          mtl = new v3d.StandardNodeMaterial();

            //mtl.color = // albedo (vec3)
            //mtl.alpha = // opacity (float)
            //mtl.roughness = // roughness (float)
            //mtl.metalness = // metalness (float)
            //mtl.reflectivity = // reflectivity (float)
            //mtl.clearCoat = // clearCoat (float)
            //mtl.clearCoatRoughness = // clearCoatRoughness (float)
            //mtl.normal = // normalmap (vec3)
            //mtl.normalScale = // normalmap scale (vec2)
            //mtl.emissive = // emissive color (vec3)
            //mtl.ambient = // ambient color (vec3)
            //mtl.shadow = // shadowmap (vec3)
            //mtl.light = // custom-light (vec3)
            //mtl.ao = // ambient occlusion (float)
            //mtl.environment = // reflection/refraction (vec3)
            //mtl.transform = // vertex transformation (vec3)

          var mask = new v3d.SwitchNode(new v3d.TextureNode(getTexture("decalDiffuse")), 'w');

          var normalScale = new v3d.FloatNode(.3);

          var roughnessA = new v3d.FloatNode(.5);
          var metalnessA = new v3d.FloatNode(.5);

          var roughnessB = new v3d.FloatNode(0);
          var metalnessB = new v3d.FloatNode(1);

          var reflectivity = new v3d.FloatNode(0);
          var clearCoat = new v3d.FloatNode(1);
          var clearCoatRoughness = new v3d.FloatNode(1);

          var roughness = new v3d.Math3Node(
              roughnessA,
              roughnessB,
              mask,
              v3d.Math3Node.MIX
            );

          var metalness = new v3d.Math3Node(
              metalnessA,
              metalnessB,
              mask,
              v3d.Math3Node.MIX
            );

          var normalMask = new v3d.OperatorNode(
              new v3d.Math1Node(mask, v3d.Math1Node.INVERT),
              normalScale,
              v3d.OperatorNode.MUL
            );

          mtl.color = new v3d.ColorNode(0xEEEEEE);
          mtl.roughness = roughness;
          mtl.metalness = metalness;
          mtl.reflectivity = reflectivity;
          mtl.clearCoat = clearCoat;
          mtl.clearCoatRoughness = clearCoatRoughness;
          mtl.environment = new v3d.CubeTextureNode(cubemap);
          mtl.normal = new v3d.TextureNode(getTexture("grassNormal"));
          mtl.normalScale = normalMask;

            // GUI

          addGui('color', mtl.color.value.getHex(), function(val) {

            mtl.color.value.setHex(val);

          }, true);

          addGui('reflectivity', reflectivity.number, function(val) {

               reflectivity.number = val;

          }, false, 0, 1);

          addGui('clearCoat', clearCoat.number, function(val) {

               clearCoat.number = val;

          }, false, 0, 1);

          addGui('clearCoatRoughness', clearCoatRoughness.number, function(val) {

               clearCoatRoughness.number = val;

          }, false, 0, 1);

          addGui('roughnessA', roughnessA.number, function(val) {

               roughnessA.number = val;

          }, false, 0, 1);

          addGui('metalnessA', metalnessA.number, function(val) {

            metalnessA.number = val;

          }, false, 0, 1);

          addGui('roughnessB', roughnessB.number, function(val) {

               roughnessB.number = val;

          }, false, 0, 1);

          addGui('metalnessB', metalnessB.number, function(val) {

            metalnessB.number = val;

          }, false, 0, 1);

          addGui('normalScale', normalScale.number, function(val) {

            normalScale.number = val;

          }, false, 0, 1);

          break;

        case 'wave':

          // MATERIAL

          mtl = new v3d.PhongNodeMaterial();

          var time = new v3d.TimerNode();
          var speed = new v3d.FloatNode(5);
          var scale = new v3d.FloatNode(1);
          var worldScale = new v3d.FloatNode(.4);
          var colorA = new v3d.ColorNode(0xFFFFFF);
          var colorB = new v3d.ColorNode(0x0054df);

          var timeScale = new v3d.OperatorNode(
            time,
            speed,
            v3d.OperatorNode.MUL
          );

          var worldScl = new v3d.OperatorNode(
            new v3d.PositionNode(),
            worldScale,
            v3d.OperatorNode.MUL
          );

          var posContinuous = new v3d.OperatorNode(
            worldScl,
            timeScale,
            v3d.OperatorNode.ADD
          );

          var wave = new v3d.Math1Node(posContinuous, v3d.Math1Node.SIN);
          wave = new v3d.SwitchNode(wave, 'x');

          var waveScale = new v3d.OperatorNode(
            wave,
            scale,
            v3d.OperatorNode.MUL
          );

          var displaceY = new v3d.JoinNode(
            new v3d.FloatNode(),
            waveScale,
            new v3d.FloatNode()
          );

          var displace = new v3d.OperatorNode(
            new v3d.NormalNode(),
            displaceY,
            v3d.OperatorNode.MUL
          );

          var blend = new v3d.OperatorNode(
            new v3d.PositionNode(),
            displaceY,
            v3d.OperatorNode.ADD
          );

          var color = new v3d.Math3Node(
            colorB,
            colorA,
            wave,
            v3d.Math3Node.MIX
          );

          mtl.color = color;
          mtl.transform = blend;

          // GUI

          addGui('speed', speed.number, function(val) {

            speed.number = val;

          }, false, 0, 10);

          addGui('scale', scale.number, function(val) {

            scale.number = val;

          }, false, 0, 3);

          addGui('worldScale', worldScale.number, function(val) {

            worldScale.number = val;

          }, false, 0, 1);

          addGui('colorA', colorA.value.getHex(), function(val) {

            colorA.value.setHex(val);

          }, true);

          addGui('colorB', colorB.value.getHex(), function(val) {

            colorB.value.setHex(val);

          }, true);

          addGui('useNormals', false, function(val) {

            blend.b = val ? displace : displaceY;

            mtl.build();

          });

          break;

        case 'rim':

          // MATERIAL

          mtl = new v3d.PhongNodeMaterial();

          var intensity = 1.3;
          var power = new v3d.FloatNode(3);
          var color = new v3d.ColorNode(0xFFFFFF);

          var viewZ = new v3d.Math2Node(
            new v3d.NormalNode(v3d.NormalNode.VIEW),
            new v3d.Vector3Node(0, 0, - intensity),
            v3d.Math2Node.DOT
          );

          var rim = new v3d.OperatorNode(
            viewZ,
            new v3d.FloatNode(intensity),
            v3d.OperatorNode.ADD
          );

          var rimPower = new v3d.Math2Node(
            rim,
            power,
            v3d.Math2Node.POW
          );

          var rimColor = new v3d.OperatorNode(
            rimPower,
            color,
            v3d.OperatorNode.MUL
          );

          mtl.color = new v3d.ColorNode(0x111111);
          mtl.emissive = rimColor;

          // GUI

          addGui('color', color.value.getHex(), function(val) {

            color.value.setHex(val);

          }, true);

          addGui('intensity', intensity, function(val) {

            intensity = val;

            viewZ.b.z = - intensity;
            rim.b.number = intensity;


          }, false, 0, 3);

          addGui('power', power.number, function(val) {

            power.number = val;

          }, false, 0, 6);

          addGui('xray', false, function(val) {

            if (val) {

              mtl.emissive = color;
              mtl.alpha = rimPower;
              mtl.blending = v3d.AdditiveBlending;
              mtl.depthWrite = false;

            }        else {

              mtl.emissive = rimColor;
              mtl.alpha = null;
              mtl.blending = v3d.NormalBlending;
              mtl.depthWrite = true;

            }

            mtl.build();

          });

          break;

        case 'color-adjustment':

          // MATERIAL

          mtl = new v3d.PhongNodeMaterial();

          var texture = new v3d.TextureNode(getTexture("brick"));

          var hue = new v3d.FloatNode();
          var sataturation = new v3d.FloatNode(1);
          var vibrance = new v3d.FloatNode();
          var brightness = new v3d.FloatNode(0);
          var contrast = new v3d.FloatNode(1);

          var hueNode = new v3d.ColorAdjustmentNode(texture, hue, v3d.ColorAdjustmentNode.HUE);
          var satNode = new v3d.ColorAdjustmentNode(hueNode, sataturation, v3d.ColorAdjustmentNode.SATURATION);
          var vibranceNode = new v3d.ColorAdjustmentNode(satNode, vibrance, v3d.ColorAdjustmentNode.VIBRANCE);
          var brightnessNode = new v3d.ColorAdjustmentNode(vibranceNode, brightness, v3d.ColorAdjustmentNode.BRIGHTNESS);
          var contrastNode = new v3d.ColorAdjustmentNode(brightnessNode, contrast, v3d.ColorAdjustmentNode.CONTRAST);

          mtl.color = contrastNode;

          // GUI

          addGui('hue', hue.number, function(val) {

            hue.number = val;

          }, false, 0, Math.PI * 2);

          addGui('saturation', sataturation.number, function(val) {

            sataturation.number = val;

          }, false, 0, 2);

          addGui('vibrance', vibrance.number, function(val) {

            vibrance.number = val;

          }, false, - 1, 1);

          addGui('brightness', brightness.number, function(val) {

            brightness.number = val;

          }, false, 0, .5);

          addGui('contrast', contrast.number, function(val) {

            contrast.number = val;

          }, false, 0, 2);

          break;

        case 'uv-transform':

          // MATERIAL

          mtl = new v3d.PhongNodeMaterial();

          var translate = new v3d.Vector2();
          var rotate = 0;
          var scale = new v3d.Vector2(1, 1);

          var texture = new v3d.TextureNode(getTexture("brick"));
          texture.coord = new v3d.UVTransformNode();
          //texture.coord.uv = new v3d.UVNode(1); // uv2 for example

          mtl.color = texture;

          // GUI

          function updateUVTransform() {

            texture.coord.compose(translate, v3d.Math.degToRad(rotate), scale);

          }

          addGui('translateX', translate.x, function(val) {

            translate.x = val;

            updateUVTransform();

          }, false, 0, 10);

          addGui('translateY', translate.y, function(val) {

            translate.y = val;

            updateUVTransform();

          }, false, 0, 10);

          addGui('scaleX', scale.x, function(val) {

            scale.x = val;

            updateUVTransform();

          }, false, .1, 5);

          addGui('scaleY', scale.y, function(val) {

            scale.y = val;

            updateUVTransform();

          }, false, .1, 5);

          addGui('rotate', rotate, function(val) {

            rotate = val;

            updateUVTransform();

          }, false, 0, 360);

          break;

        case 'bump':

          // MATERIAL

          mtl = new v3d.PhongNodeMaterial();

          var diffuse = new v3d.TextureNode(getTexture("brick"));

          var bump = new v3d.BumpNode(new v3d.TextureNode(getTexture("brick")));
          bump.scale = new v3d.Vector2Node(- 1.5, - 1.5);

          mtl.color = diffuse;
          mtl.normal = bump;

          // GUI

          addGui('scaleX', bump.scale.x, function(val) {

            bump.scale.x = val;

          }, false, - 2, 2);

          addGui('scaleY', bump.scale.y, function(val) {

            bump.scale.y = val;

          }, false, - 2, 2);

          addGui('color', true, function(val) {

            mtl.color = val ? diffuse : new v3d.ColorNode(0xEEEEEE);

            mtl.build();

          });

          break;

        case 'blur':

          // MATERIAL

          mtl = new v3d.PhongNodeMaterial();

          var diffuse = new v3d.TextureNode(getTexture("brick"));

          var blur = new v3d.BlurNode(new v3d.TextureNode(getTexture("brick")));

          mtl.color = blur;

          // GUI

          addGui('radiusX', blur.radius.x, function(val) {

            blur.radius.x = val;

          }, false, 0, 15);

          addGui('radiusY', blur.radius.y, function(val) {

            blur.radius.y = val;

          }, false, 0, 15);

          break;

        case 'spherical-reflection':

          // MATERIAL

          mtl = new v3d.PhongNodeMaterial();

          mtl.environment = new v3d.TextureNode(getTexture("spherical"), new v3d.ReflectNode(v3d.ReflectNode.SPHERE));

          break;

        case 'fresnel':

          // MATERIAL

          mtl = new v3d.PhongNodeMaterial();

          var reflectance = new v3d.FloatNode(1.3);
          var power = new v3d.FloatNode(1);
          var color = new v3d.CubeTextureNode(cubemap);

          var viewZ = new v3d.Math2Node(
            new v3d.NormalNode(v3d.NormalNode.VIEW),
            new v3d.Vector3Node(0, 0, - 1),
            v3d.Math2Node.DOT
          );

          var theta = new v3d.OperatorNode(
            viewZ,
            new v3d.FloatNode(1),
            v3d.OperatorNode.ADD
          );

          var thetaPower = new v3d.Math2Node(
            theta,
            power,
            v3d.Math2Node.POW
          );

          var fresnel = new v3d.OperatorNode(
            reflectance,
            thetaPower,
            v3d.OperatorNode.MUL
          );

          mtl.color = new v3d.ColorNode(0x3399FF);
          mtl.environment = color;
          mtl.environmentAlpha = new v3d.Math1Node(fresnel, v3d.Math1Node.SAT);

          // GUI

          addGui('reflectance', reflectance.number, function(val) {

            reflectance.number = val;

          }, false, 0, 3);

          addGui('power', power.number, function(val) {

            power.number = val;

          }, false, 0, 5);

          break;

        case 'layers':

          // MATERIAL

          mtl = new v3d.PhongNodeMaterial();

          var tex1 = new v3d.TextureNode(getTexture("grass"));
          var tex2 = new v3d.TextureNode(getTexture("brick"));

          var offset = new v3d.FloatNode(0);
          var scale = new v3d.FloatNode(1);
          var uv = new v3d.UVNode();

          var uvOffset = new v3d.OperatorNode(
            offset,
            uv,
            v3d.OperatorNode.ADD
          );

          var uvScale = new v3d.OperatorNode(
            uvOffset,
            scale,
            v3d.OperatorNode.MUL
          );

          var mask = new v3d.TextureNode(getTexture("decalDiffuse"), uvScale);
          var maskAlphaChannel = new v3d.SwitchNode(mask, 'w');

          var blend = new v3d.Math3Node(
            tex1,
            tex2,
            maskAlphaChannel,
            v3d.Math3Node.MIX
          );

          mtl.color = blend;

          // GUI

          addGui('offset', offset.number, function(val) {

            offset.number = val;

          }, false, 0, 1);

          addGui('scale', scale.number, function(val) {

            scale.number = val;

          }, false, 0, 10);

          break;

        case 'saturation':

          // MATERIAL

          mtl = new v3d.StandardNodeMaterial();

          var tex = new v3d.TextureNode(getTexture("brick"));
          var sat = new v3d.FloatNode(0);

          var satrgb = new v3d.FunctionNode([
            "vec3 satrgb(vec3 rgb, float adjustment) {",
          //"  const vec3 W = vec3(0.2125, 0.7154, 0.0721);", // LUMA
            "  vec3 intensity = vec3(dot(rgb, LUMA));",
            "  return mix(intensity, rgb, adjustment);",
            "}"
          ].join("\n"));

          var saturation = new v3d.FunctionCallNode(satrgb);
          saturation.inputs.rgb = tex;
          saturation.inputs.adjustment = sat;

          // or try

          //saturation.inputs[0] = tex;
          //saturation.inputs[1] = sat;

          mtl.color = saturation;

          // GUI

          addGui('saturation', sat.number, function(val) {

            sat.number = val;

          }, false, 0, 2);

          break;

        case 'top-bottom':

          // MATERIAL

          mtl = new v3d.PhongNodeMaterial();

          var top = new v3d.TextureNode(getTexture("grass"));
          var bottom = new v3d.TextureNode(getTexture("brick"));

          var normal = new v3d.NormalNode(v3d.NormalNode.WORLD);
          var normalY = new v3d.SwitchNode(normal, 'y');

          var hard = new v3d.FloatNode(9);
          var offset = new v3d.FloatNode(- 2.5);

          var hardClamp = new v3d.OperatorNode(
            normalY,
            hard,
            v3d.OperatorNode.MUL
          );

          var offsetClamp = new v3d.OperatorNode(
            hardClamp,
            offset,
            v3d.OperatorNode.ADD
          );

          var clamp0at1 = new v3d.Math1Node(offsetClamp, v3d.Math1Node.SAT);

          var blend = new v3d.Math3Node(top, bottom, clamp0at1, v3d.Math3Node.MIX);

          mtl.color = blend;

          // GUI

          addGui('hard', hard.number, function(val) {

            hard.number = val;

          }, false, 0, 20);

          addGui('offset', offset.number, function(val) {

            offset.number = val;

          }, false, - 10, 10);

          break;

        case 'displace':

          // MATERIAL

          mtl = new v3d.PhongNodeMaterial();

          var time = new v3d.TimerNode();
          var scale = new v3d.FloatNode(2);
          var speed = new v3d.FloatNode(.2);
          var colorA = new v3d.ColorNode(0xFFFFFF);
          var colorB = new v3d.ColorNode(0x0054df);

          var uv = new v3d.UVNode();

          var timeScl = new v3d.OperatorNode(
            time,
            speed,
            v3d.OperatorNode.MUL
          );

          var displaceOffset = new v3d.OperatorNode(
            timeScl,
            uv,
            v3d.OperatorNode.ADD
          );

          var tex = new v3d.TextureNode(getTexture("cloud"), displaceOffset);
          var texArea = new v3d.SwitchNode(tex, 'w');

          var displace = new v3d.OperatorNode(
            new v3d.NormalNode(),
            texArea,
            v3d.OperatorNode.MUL
          );

          var displaceScale = new v3d.OperatorNode(
            displace,
            scale,
            v3d.OperatorNode.MUL
          );

          var blend = new v3d.OperatorNode(
            new v3d.PositionNode(),
            displaceScale,
            v3d.OperatorNode.ADD
          );

          var color = new v3d.Math3Node(
            colorB,
            colorA,
            texArea,
            v3d.Math3Node.MIX
          );

          mtl.color = mtl.specular = new v3d.ColorNode(0);
          mtl.emissive = color;
          mtl.transform = blend;

          // GUI

          addGui('speed', speed.number, function(val) {

            speed.number = val;

          }, false, 0, 1);

          addGui('scale', scale.number, function(val) {

            scale.number = val;

          }, false, 0, 10);

          addGui('colorA', colorA.value.getHex(), function(val) {

            colorA.value.setHex(val);

          }, true);

          addGui('colorB', colorB.value.getHex(), function(val) {

            colorB.value.setHex(val);

          }, true);

          break;

        case 'smoke':

          // MATERIAL

          mtl = new v3d.PhongNodeMaterial();

          var time = new v3d.TimerNode();
          var uv = new v3d.UVNode();

          var timeSpeedA = new v3d.OperatorNode(
            time,
            new v3d.Vector2Node(0.3, 0.1),
            v3d.OperatorNode.MUL
          );

          var timeSpeedB = new v3d.OperatorNode(
            time,
            new v3d.Vector2Node(0.15, 0.4),
            v3d.OperatorNode.MUL
          );

          var uvOffsetA = new v3d.OperatorNode(
            timeSpeedA,
            uv,
            v3d.OperatorNode.ADD
          );

          var uvOffsetB = new v3d.OperatorNode(
            timeSpeedB,
            uv,
            v3d.OperatorNode.ADD
          );

          var cloudA = new v3d.TextureNode(getTexture("cloud"), uvOffsetA);
          var cloudB = new v3d.TextureNode(getTexture("cloud"), uvOffsetB);

          var clouds = new v3d.OperatorNode(
            cloudA,
            cloudB,
            v3d.OperatorNode.ADD
          );

          mtl.environment = new v3d.ColorNode(0xFFFFFF);
          mtl.alpha = clouds;

          // GUI

          addGui('color', mtl.environment.value.getHex(), function(val) {

            mtl.environment.value.setHex(val);

          }, true);

          break;

        case 'camera-depth':

          // MATERIAL

          var colorA = new v3d.ColorNode(0xFFFFFF);
          var colorB = new v3d.ColorNode(0x0054df);

          var depth = new v3d.CameraNode(v3d.CameraNode.DEPTH);
          depth.near.number = 1;
          depth.far.number = 200;

          var colors = new v3d.Math3Node(
            colorB,
            colorA,
            depth,
            v3d.Math3Node.MIX
          );

          mtl = new v3d.PhongNodeMaterial();
          mtl.color = colors;

          // GUI

          addGui('near', depth.near.number, function(val) {

            depth.near.number = val;

          }, false, 1, 1200);

          addGui('far', depth.far.number, function(val) {

            depth.far.number = val;

          }, false, 1, 1200);

          addGui('nearColor', colorA.value.getHex(), function(val) {

            colorA.value.setHex(val);

          }, true);

          addGui('farColor', colorB.value.getHex(), function(val) {

            colorB.value.setHex(val);

          }, true);

          break;

        case 'caustic':

          // MATERIAL

          mtl = new v3d.StandardNodeMaterial();

          var hash2 = new v3d.FunctionNode([
            "vec2 hash2(vec2 p) {",
            "  return fract(sin(vec2(dot(p, vec2(123.4, 748.6)), dot(p, vec2(547.3, 659.3))))*5232.85324);",
            "}"
          ].join("\n"));

          var voronoi = new v3d.FunctionNode([
          // Based off of iq's described here: http://www.iquilezles.org/www/articles/voronoili
            "float voronoi(vec2 p, in float time) {",
            "  vec2 n = floor(p);",
            "  vec2 f = fract(p);",
            "  float md = 5.0;",
            "  vec2 m = vec2(0.0);",
            "  for (int i = -1; i <= 1; i++) {",
            "    for (int j = -1; j <= 1; j++) {",
            "      vec2 g = vec2(i, j);",
            "      vec2 o = hash2(n + g);",
            "      o = 0.5 + 0.5 * sin(time + 5.038 * o);",
            "      vec2 r = g + o - f;",
            "      float d = dot(r, r);",
            "      if (d < md) {",
            "        md = d;",
            "        m = n+g+o;",
            "      }",
            "    }",
            "  }",
            "  return md;",
            "}"
          ].join("\n"), [hash2]); // define hash2 as dependencies

          var voronoiLayers = new v3d.FunctionNode([
          // based on https://www.shadertoy.com/view/4tXSDf
            "float voronoiLayers(vec2 p, in float time) {",
            "  float v = 0.0;",
            "  float a = 0.4;",
            "  for (int i = 0; i < 3; i++) {",
            "    v += voronoi(p, time) * a;",
            "    p *= 2.0;",
            "    a *= 0.5;",
            "  }",
            "  return v;",
            "}"
          ].join("\n"), [voronoi]); // define voronoi as dependencies

          var time = new v3d.TimerNode();
          var timeScale = new v3d.FloatNode(2);

          var alpha = new v3d.FloatNode(1);
          var scale = new v3d.FloatNode(.1);
          var intensity = new v3d.FloatNode(1.5);

          var color = new v3d.ColorNode(0xFFFFFF);
          var colorA = new v3d.ColorNode(0xFFFFFF);
          var colorB = new v3d.ColorNode(0x0054df);

          var worldPos = new v3d.PositionNode(v3d.PositionNode.WORLD);
          var worldPosTop = new v3d.SwitchNode(worldPos, 'xz');

          var worldNormal = new v3d.NormalNode(v3d.NormalNode.WORLD);

          var mask = new v3d.SwitchNode(worldNormal, 'y');

          // clamp0at1
          mask = new v3d.Math1Node(mask, v3d.Math1Node.SAT);

          var timeOffset = new v3d.OperatorNode(
            time,
            timeScale,
            v3d.OperatorNode.MUL
          );

          var uvPos = new v3d.OperatorNode(
            worldPosTop,
            scale,
            v3d.OperatorNode.MUL
          );

          var voronoi = new v3d.FunctionCallNode(voronoiLayers);
          voronoi.inputs.p = uvPos;
          voronoi.inputs.time = timeOffset;

          var maskCaustic = new v3d.OperatorNode(
            alpha,
            mask,
            v3d.OperatorNode.MUL
          );

          var voronoiIntensity = new v3d.OperatorNode(
            voronoi,
            intensity,
            v3d.OperatorNode.MUL
          );

          var voronoiColors = new v3d.Math3Node(
            colorB,
            colorA,
            new v3d.Math1Node(voronoiIntensity, v3d.Math1Node.SAT), // mix needs clamp
            v3d.Math3Node.MIX
          );

          var caustic = new v3d.Math3Node(
            color,
            voronoiColors,
            maskCaustic,
            v3d.Math3Node.MIX
          );

          var causticLights = new v3d.OperatorNode(
            voronoiIntensity,
            maskCaustic,
            v3d.OperatorNode.MUL
          );

          mtl.color = caustic;
          mtl.ambient = causticLights;

          // GUI

          addGui('timeScale', timeScale.number, function(val) {

            timeScale.number = val;

          }, false, 0, 5);

          addGui('intensity', intensity.number, function(val) {

            intensity.number = val;

          }, false, 0, 3);

          addGui('scale', scale.number, function(val) {

            scale.number = val;

          }, false, 0, 1);

          addGui('alpha', alpha.number, function(val) {

            alpha.number = val;

          }, false, 0, 1);

          addGui('color', color.value.getHex(), function(val) {

            color.value.setHex(val);

          }, true);

          addGui('colorA', colorA.value.getHex(), function(val) {

            colorA.value.setHex(val);

          }, true);

          addGui('colorB', colorB.value.getHex(), function(val) {

            colorB.value.setHex(val);

          }, true);

          break;

        case 'soft-body':

          // MATERIAL

          move = true;

          mtl = new v3d.StandardNodeMaterial();

          var scale = new v3d.FloatNode(2);
          var colorA = new v3d.ColorNode(0xFF6633);
          var colorB = new v3d.ColorNode(0x3366FF);

          var pos = new v3d.PositionNode();
          var posNorm = new v3d.Math1Node(pos, v3d.Math1Node.NORMALIZE);

          var mask = new v3d.SwitchNode(posNorm, 'y');

          var velocity = new v3d.VelocityNode(mesh, {
            type: 'elastic',
            spring: .95,
            damping: .95
          });

          var velocityArea = new v3d.OperatorNode(
            mask,
            scale,
            v3d.OperatorNode.MUL
          );

          var softVelocity = new v3d.OperatorNode(
            velocity,
            velocityArea,
            v3d.OperatorNode.MUL
          );

          var softPosition = new v3d.OperatorNode(
            new v3d.PositionNode(),
            softVelocity,
            v3d.OperatorNode.ADD
          );

          var colors = new v3d.Math3Node(
            colorB,
            colorA,
            mask,
            v3d.Math3Node.MIX
          );

          mtl.color = colors;
          mtl.transform = softPosition;

          // GUI

          addGui('spring', velocity.params.spring, function(val) {

            velocity.params.spring = val;

          }, false, 0, .95);

          addGui('damping', velocity.params.damping, function(val) {

            velocity.params.damping = val;

          }, false, 0, .95);

          addGui('scale', scale.number, function(val) {

            scale.number = val;

          }, false, 0, 3);

          addGui('softBody', colorA.value.getHex(), function(val) {

            colorA.value.setHex(val);

          }, true);

          addGui('rigidBody', colorB.value.getHex(), function(val) {

            colorB.value.setHex(val);

          }, true);

          break;

        case 'plush':

          // MATERIAL

          mtl = new v3d.PhongNodeMaterial();

          var color = new v3d.ColorNode(0x8D8677);
          var mildness = new v3d.FloatNode(1.6);
          var fur = new v3d.FloatNode(.5);

          var posDirection = new v3d.Math1Node(new v3d.PositionNode(v3d.PositionNode.VIEW), v3d.Math1Node.NORMALIZE);
          var norDirection = new v3d.Math1Node(new v3d.NormalNode(v3d.NormalNode.VIEW), v3d.Math1Node.NORMALIZE);

          var viewZ = new v3d.Math2Node(
            posDirection,
            norDirection,
            v3d.Math2Node.DOT
          );

          // without luma correction for now
          var mildnessColor = new v3d.OperatorNode(
            color,
            mildness,
            v3d.OperatorNode.MUL
          );

          var furScale = new v3d.OperatorNode(
            viewZ,
            fur,
            v3d.OperatorNode.MUL
          );

          mtl.color = color;
          mtl.normal = new v3d.TextureNode(getTexture("grassNormal"));
          mtl.normalScale = furScale;
          mtl.environment = mildnessColor;
          mtl.environmentAlpha = new v3d.Math1Node(viewZ, v3d.Math1Node.INVERT);
          mtl.shininess = new v3d.FloatNode(0);

          // GUI

          addGui('color', color.value.getHex(), function(val) {

            color.value.setHex(val);

          }, true);

          addGui('mildness', mildness.number, function(val) {

            mildness.number = val;

          }, false, 1, 2);

          addGui('fur', fur.number, function(val) {

            fur.number = val;

          }, false, 0, 2);

          break;

        case 'skin':
        case 'skin-phong':

          // MATERIAL

          mtl = name == 'skin' ? new v3d.StandardNodeMaterial() : new v3d.PhongNodeMaterial();

          var skinColor = new v3d.ColorNode(0xFFC495);
          var bloodColor = new v3d.ColorNode(0x6b0602);
          var wrapLight = new v3d.FloatNode(1.5);
          var wrapShadow = new v3d.FloatNode(0);

          var directLight = new v3d.LightNode();

          var lightLuminance = new v3d.LuminanceNode(directLight);

          var lightWrap = new v3d.Math3Node(
            wrapShadow,
            wrapLight,
            lightLuminance,
            v3d.Math3Node.SMOOTHSTEP
          );

          var lightTransition = new v3d.OperatorNode(
            lightWrap,
            new v3d.ConstNode(v3d.ConstNode.PI2),
            v3d.OperatorNode.MUL
          );

          var wrappedLight = new v3d.Math1Node(lightTransition, v3d.Math1Node.SIN);

          var wrappedLightColor = new v3d.OperatorNode(
            wrappedLight,
            bloodColor,
            v3d.OperatorNode.MUL
          );

          var bloodArea = new v3d.Math1Node(wrappedLightColor, v3d.Math1Node.SAT);

          var totalLight = new v3d.OperatorNode(
            directLight,
            bloodArea,
            v3d.OperatorNode.ADD
          );

          mtl.color = skinColor;
          mtl.light = totalLight;

          if (name == 'skin') {

            // StandardNodeMaterial

            mtl.metalness = new v3d.FloatNode(0);
            mtl.roughness = new v3d.FloatNode(1);
            mtl.reflectivity = new v3d.FloatNode(0);
            mtl.clearCoat = new v3d.FloatNode(.2);
            mtl.clearCoatRoughness = new v3d.FloatNode(.3);
            mtl.environment = new v3d.CubeTextureNode(cubemap);

          } else {

            // PhongNodeMaterial

            mtl.specular = new v3d.ColorNode(0x2f2e2d);
            mtl.shininess = new v3d.FloatNode(15);

          }

          // GUI

          addGui('skinColor', skinColor.value.getHex(), function(val) {

            skinColor.value.setHex(val);

          }, true);

          addGui('bloodColor', bloodColor.value.getHex(), function(val) {

            bloodColor.value.setHex(val);

          }, true);

          addGui('wrapLight', wrapLight.number, function(val) {

            wrapLight.number = val;

          }, false, 0, 3);

          addGui('wrapShadow', wrapShadow.number, function(val) {

            wrapShadow.number = val;

          }, false, - 1, 0);

          break;

        case 'toon':

          // MATERIAL

          mtl = new v3d.PhongNodeMaterial();

          var count = new v3d.FloatNode(3.43);
          var sceneDirectLight = new v3d.LightNode();
          var color = new v3d.ColorNode(0xAABBFF);

          var lineColor = new v3d.ColorNode(0xFF0000);
          var lineSize = new v3d.FloatNode(0.23);
          var lineInner = new v3d.FloatNode(0);

          // CEL

          var lightLuminance = new v3d.LuminanceNode(sceneDirectLight);

          var preCelLight = new v3d.OperatorNode(
            lightLuminance,
            count,
            v3d.OperatorNode.MUL
          );

          var celLight = new v3d.Math1Node(
            preCelLight,
            v3d.Math1Node.CEIL
          );

          var posCelLight = new v3d.OperatorNode(
            celLight,
            count,
            v3d.OperatorNode.DIV
          );

          // LINE

          var posDirection = new v3d.Math1Node(new v3d.PositionNode(v3d.PositionNode.VIEW), v3d.Math1Node.NORMALIZE);
          var norDirection = new v3d.Math1Node(new v3d.NormalNode(v3d.NormalNode.VIEW), v3d.Math1Node.NORMALIZE);

          var viewZ = new v3d.Math2Node(
            posDirection,
            norDirection,
            v3d.Math2Node.DOT
          );

          var lineOutside = new v3d.Math1Node(
            viewZ,
            v3d.Math1Node.ABS
          );

          var line = new v3d.OperatorNode(
            lineOutside,
            new v3d.FloatNode(1),
            v3d.OperatorNode.DIV
          );

          var lineScaled = new v3d.Math3Node(
            line,
            lineSize,
            lineInner,
            v3d.Math3Node.SMOOTHSTEP
          );

          var innerContour = new v3d.Math1Node(new v3d.Math1Node(lineScaled, v3d.Math1Node.SAT), v3d.Math1Node.INVERT);

          // APPLY

          mtl.color = color;
          mtl.light = posCelLight;
          mtl.shininess = new v3d.FloatNode(0);

          mtl.environment = lineColor;
          mtl.environmentAlpha = innerContour;

          // GUI

          addGui('color', color.value.getHex(), function(val) {

            color.value.setHex(val);

          }, true);

          addGui('lineColor', lineColor.value.getHex(), function(val) {

            lineColor.value.setHex(val);

          }, true);

          addGui('count', count.number, function(val) {

            count.number = val;

          }, false, 1, 8);

          addGui('lineSize', lineSize.number, function(val) {

            lineSize.number = val;

          }, false, 0, 1);

          addGui('lineInner', lineInner.number, function(val) {

            lineInner.number = val;

          }, false, 0, 1);

          addGui('ignoreIndirectLight', false, function(val) {

            mtl.ao = val ? new v3d.FloatNode() : undefined;

            mtl.build();

          });

          break;

        case 'custom-attribute':

          // GEOMETRY

          // add "position" buffer to "custom" attribute
          teapot.attributes['custom'] = teapot.attributes['position'];

          // MATERIAL

          mtl = new v3d.PhongNodeMaterial();

          mtl.color = new v3d.AttributeNode("custom", 3);

          // or

          //mtl.color = new v3d.AttributeNode("custom", "vec3");

          break;

        case 'expression':

          // MATERIAL

          mtl = new v3d.PhongNodeMaterial();

          var speed = new v3d.FloatNode(.5);

          mtl.color = new v3d.FunctionNode("myCustomUv + (sin(time*speed)*.5) + (position * .05)", "vec3");
          mtl.color.keywords["speed"] = speed;

          mtl.transform = new v3d.FunctionNode("mod(time*speed,1.0) < 0.5 ? position + (worldNormal*(1.0+sin(time*speed*1.0))*3.0) : position + sin(position.x * sin(time*speed*2.0))", "vec3");
          mtl.transform.keywords["speed"] = speed;

          // add global keyword (variable or const)
          v3d.NodeLib.addKeyword('myCustomUv', function(builder) {

            return new v3d.ReflectNode();

          });

          // GUI

          addGui('speed', speed.number, function(val) {

            speed.number = val;

          }, false, 0, 1);

          break;

        case 'reserved-keywords':

          // MATERIAL

          mtl = new v3d.PhongNodeMaterial();

          var keywordsexample = new v3d.FunctionNode([
          // use "uv" reserved keyword
            "vec4 keywordsexample(sampler2D texture) {",
            "  return texture2D(texture, myUV) + vec4(position * myAlpha, 0.0);",
            "}"
          ].join("\n"));

          // add local keyword (const only)
          keywordsexample.keywords["myAlpha"] = new v3d.ConstNode("float myAlpha .05");

          // add global keyword (const only)
          v3d.NodeLib.addKeyword('myUV', function(builder) {

            return new v3d.UVNode();

          });

          // add global const or function
          //v3d.NodeLib.add(new v3d.ConstNode("float MY_CONST .05"))

          // reserved keywords
          console.log(v3d.NodeLib.keywords);

          // keywords conflit? use this to disable:
          //blurtexture.useKeywords = false; // (true is default)

          mtl.color = new v3d.FunctionCallNode(keywordsexample, [new v3d.TextureNode(getTexture("brick"))]);

          break;

        case 'varying':

          // MATERIAL

          mtl = new v3d.PhongNodeMaterial();

          var varying = new v3d.VarNode("vec3");

          var setMyVar = new v3d.FunctionNode([
            "float setMyVar(vec3 pos) {",
          // set "myVar" in vertex shader in this example,
          // can be used in fragment shader too or in rest of the current shader
            "  myVar = pos;",
          // it is not accept "void" functions for now!
            "  return 0.;",
            "}"
          ].join("\n"));

          // add keyword
          setMyVar.keywords["myVar"] = varying;

          var transform = new v3d.FunctionNode("setMyVar(position * .1) + position", "vec3", [setMyVar]);
          transform.keywords["tex"] = new v3d.TextureNode(getTexture("brick"));

          mtl.transform = transform;
          mtl.color = varying;

          break;

        case 'triangle-blur':

          // MATERIAL

          mtl = new v3d.PhongNodeMaterial();

          var delta = new v3d.Vector2Node(.5, .25);
          var alpha = new v3d.FloatNode(1);

          var blurtexture = new v3d.FunctionNode([
          // Reference: TriangleBlurShader.js
            "vec4 blurtexture(sampler2D texture, vec2 uv, vec2 delta) {",
            "  vec4 color = vec4(0.0);",
            "  float total = 0.0;",
          // randomize the lookup values to hide the fixed number of samples
            "  float offset = rand(uv);",
            "  for (float t = -BLUR_ITERATIONS; t <= BLUR_ITERATIONS; t ++) {",
            "    float percent = (t + offset - 0.5) / BLUR_ITERATIONS;",
            "    float weight = 1.0 - abs(percent);",
            "    color += texture2D(texture, uv + delta * percent) * weight;",
            "    total += weight;",
            "  }",
            "  return color / total;",
            "}"
          ].join("\n"), [new v3d.ConstNode("float BLUR_ITERATIONS 10.0")]);

          var blurredTexture = new v3d.FunctionCallNode(blurtexture, {
            texture: new v3d.TextureNode(getTexture("brick")),
            delta: delta,
            uv: new v3d.UVNode()
          });

          var color = new v3d.Math3Node(
            new v3d.TextureNode(getTexture("brick")),
            blurredTexture,
            alpha,
            v3d.Math3Node.MIX
          );

          mtl.color = color;

          // GUI

          addGui('alpha', alpha.number, function(val) {

            alpha.number = val;

          }, false, 0, 1);

          addGui('deltaX', delta.x, function(val) {

            delta.x = val;

          }, false, 0, 1);

          addGui('deltaY', delta.x, function(val) {

            delta.y = val;

          }, false, 0, 1);

          break;

        case 'firefly':

          // MATERIAL

          mtl = new v3d.PhongNodeMaterial();

          var time = new v3d.TimerNode();
          var speed = new v3d.FloatNode(.5);

          var color = new v3d.ColorNode(0x98ff00);

          var timeSpeed = new v3d.OperatorNode(
            time,
            speed,
            v3d.OperatorNode.MUL
          );

          var sinCycleInSecs = new v3d.OperatorNode(
            timeSpeed,
            new v3d.ConstNode(v3d.ConstNode.PI2),
            v3d.OperatorNode.MUL
          );

          var cycle = new v3d.Math1Node(sinCycleInSecs, v3d.Math1Node.SIN);

          var cycleColor = new v3d.OperatorNode(
            cycle,
            color,
            v3d.OperatorNode.MUL
          );

          var cos = new v3d.Math1Node(cycleColor, v3d.Math1Node.SIN);

          mtl.color = new v3d.ColorNode(0);
          mtl.emissive = cos;

          // GUI

          addGui('speed', speed.number, function(val) {

            speed.number = val;

          }, false, 0, 3);

          break;

        case 'sss':
        case 'translucent':

          // DISTANCE FORMULA

          var modelPos = new v3d.Vector3Node();

          var viewPos = new v3d.PositionNode(v3d.PositionNode.VIEW);
          var cameraPosition = new v3d.CameraNode(v3d.CameraNode.POSITION);

          var cameraDistance = new v3d.Math2Node(
            modelPos,
            cameraPosition,
            v3d.Math2Node.DISTANCE
          );

          var viewPosZ = new v3d.SwitchNode(viewPos, 'z');

          var distance = new v3d.OperatorNode(
            cameraDistance,
            viewPosZ,
            v3d.OperatorNode.SUB
          );

          var distanceRadius = new v3d.OperatorNode(
            distance,
            new v3d.FloatNode(70),
            v3d.OperatorNode.ADD
          );

          var objectDepth = new v3d.Math3Node(
            distanceRadius,
            new v3d.FloatNode(0),
            new v3d.FloatNode(50),
            v3d.Math3Node.SMOOTHSTEP
          );

          // RTT (get back distance)

          rtTexture = new v3d.WebGLRenderTarget(window.innerWidth, window.innerHeight, { minFilter: v3d.LinearFilter, magFilter: v3d.NearestFilter, format: v3d.RGBFormat });

          var distanceMtl = new v3d.PhongNodeMaterial();
          distanceMtl.environment = objectDepth;
          distanceMtl.side = v3d.BackSide;
          distanceMtl.build();

          rtMaterial = distanceMtl;

          // MATERIAL

          mtl = new v3d.StandardNodeMaterial();

          var backSideDepth = new v3d.TextureNode(rtTexture, new v3d.ScreenUVNode(new v3d.ResolutionNode(renderer)));

          var difference = new v3d.OperatorNode(
            objectDepth,
            backSideDepth,
            v3d.OperatorNode.SUB
          );

          var sss = new v3d.Math3Node(
            new v3d.FloatNode(- .1),
            new v3d.FloatNode(.5),
            difference,
            v3d.Math3Node.SMOOTHSTEP
          );

          var sssAlpha = new v3d.Math1Node(sss, v3d.Math1Node.SAT);

          var frontColor, backColor;

          if (name == 'sss') {

            var sssOut = new v3d.Math2Node(
              objectDepth,
              sssAlpha,
              v3d.Math2Node.MIN
            );

            frontColor = new v3d.ColorNode(0xd4cfbb);
            backColor = new v3d.ColorNode(0xd04327);

            var color = new v3d.Math3Node(
              backColor,
              frontColor,
              sssOut,
              v3d.Math3Node.MIX
            );

            var light = new v3d.OperatorNode(
              new v3d.LightNode(),
              color,
              v3d.OperatorNode.ADD
            );

            mtl.color = frontColor;
            mtl.roughness = new v3d.FloatNode(.1);
            mtl.metalness = new v3d.FloatNode(.5);

            mtl.light = light;
            mtl.environment = color;

          } else {

            frontColor = new v3d.ColorNode(0xd04327);
            backColor = new v3d.ColorNode(0x1a0e14);

            var color = new v3d.Math3Node(
              frontColor,
              backColor,
              sssAlpha,
              v3d.Math3Node.MIX
            );

            var light = new v3d.OperatorNode(
              new v3d.LightNode(),
              color,
              v3d.OperatorNode.ADD
            );

            mtl.color = new v3d.ColorNode(0xffffff);
            mtl.roughness = new v3d.FloatNode(.1);
            mtl.metalness = new v3d.FloatNode(.5);

            mtl.light = light;
            mtl.environment = color;

          }

          // GUI

          addGui('frontColor', frontColor.value.getHex(), function(val) {

            frontColor.value.setHex(val);

          }, true);

          addGui('backColor', backColor.value.getHex(), function(val) {

            backColor.value.setHex(val);

          }, true);

          addGui('area', sss.b.number, function(val) {

            sss.b.number = val;

          }, false, 0, 1);

          break;

      }

      // build shader
      mtl.build();

      // set material
      mesh.material = mtl;

    }

    function onWindowResize() {

      var width = window.innerWidth, height = window.innerHeight;

      camera.aspect = width / height;
      camera.updateProjectionMatrix();

      renderer.setSize(width, height);

      if (rtTexture) rtTexture.setSize(width, height);

    }

    function animate() {

      var delta = clock.getDelta();

      if (move) {

        var time = Date.now() * 0.005;

        mesh.position.z = Math.cos(time) * 10;
        mesh.position.y = Math.sin(time) * 10;

      } else {

        mesh.position.z = mesh.position.y = 0;

      }

      //mesh.rotation.z += .01;

      // update material animation and/or gpu calcs (pre-renderer)
      mesh.material.updateFrame(delta);

      // render to texture for sss/translucent material only
      if (rtTexture) {

        scene.overrideMaterial = rtMaterial;

        renderer.render(scene, camera, rtTexture, true);

        scene.overrideMaterial = null;

      }

      renderer.render(scene, camera);

      requestAnimationFrame(animate);

    }

    </script>

  </body>
</html>
